---
title: å…¨å±€ PR å¯¼å…¥å’Œ Embedding åŸºç¡€è®¾æ–½
created: 2026-02-12
type: infrastructure
priority: P1
---

# PRD: å…¨å±€ PR å¯¼å…¥å’Œ Embedding åŸºç¡€è®¾æ–½

## èƒŒæ™¯

Cecelia Brain éœ€è¦åœ¨åˆ›å»ºæ–°ä»»åŠ¡å‰æœç´¢ç›¸ä¼¼çš„å†å²å·¥ä½œï¼Œé¿å…é‡å¤åŠ³åŠ¨ã€‚ç›®å‰ï¼š

1. **é—®é¢˜**ï¼šTask Database ä¸ºç©ºï¼Œæ— æ³•æœç´¢å†å²
2. **æ•°æ®æº**ï¼šæ‰€æœ‰ repos çš„ PR å°±æ˜¯å†å²ä»»åŠ¡è®°å½•
3. **ç°çŠ¶**ï¼šå¯¼å…¥è„šæœ¬å’Œ embedding é…ç½®åˆ†æ•£åœ¨ cecelia-coreï¼Œä½†è¿™æ˜¯å…¨å±€åŸºç¡€è®¾æ–½

## ç›®æ ‡

å°† PR å¯¼å…¥å’Œ Embedding é…ç½®ä» cecelia-core è¿ç§»åˆ° infrastructure repoï¼Œä½œä¸ºå…¨å±€åŸºç¡€è®¾æ–½ç®¡ç†ã€‚

## åŠŸèƒ½éœ€æ±‚

### 1. å…¨å±€ PR å¯¼å…¥è„šæœ¬

**ä½ç½®**ï¼š`scripts/import-all-prs.js`

**åŠŸèƒ½**ï¼š
- æ‰«ææ‰€æœ‰é…ç½®çš„ repositoriesï¼ˆ~13 ä¸ªï¼‰
- é€šè¿‡ `gh pr list` è·å–æ‰€æœ‰ merged PRsï¼ˆlimit 500ï¼‰
- æ’å…¥åˆ° PostgreSQL tasks è¡¨
- è‡ªåŠ¨åˆ›å»º/æŸ¥æ‰¾å¯¹åº”çš„ project è®°å½•
- å¹‚ç­‰æ€§ï¼šå·²å­˜åœ¨çš„ PR ä¸é‡å¤å¯¼å…¥

**é…ç½®çš„ Repos**ï¼š
```javascript
const REPOS = [
  // Cecelia ç³»åˆ—
  { path: '/home/xx/perfect21/cecelia/core', name: 'cecelia-core', owner: 'perfectuser21' },
  { path: '/home/xx/perfect21/cecelia/engine', name: 'cecelia-engine', owner: 'perfectuser21' },
  { path: '/home/xx/perfect21/cecelia/workspace', name: 'cecelia-workspace', owner: 'perfectuser21' },
  { path: '/home/xx/perfect21/cecelia/workflows', name: 'cecelia-workflows', owner: 'perfectuser21' },
  { path: '/home/xx/perfect21/cecelia/quality', name: 'cecelia-quality', owner: 'perfectuser21' },

  // ZenithJoy ç³»åˆ—
  { path: '/home/xx/perfect21/zenithjoy/workspace', name: 'zenithjoy-workspace', owner: 'perfectuser21' },
  { path: '/home/xx/perfect21/zenithjoy/creator', name: 'creator', owner: 'zenjoymedia' },
  { path: '/home/xx/perfect21/zenithjoy/geoai', name: 'geoai', owner: 'zenjoymedia' },
  { path: '/home/xx/perfect21/zenithjoy/JNSY-Label', name: 'JNSY-Label', owner: 'zenjoymedia' },

  // å…¶ä»–é¡¹ç›®
  { path: '/home/xx/perfect21/infrastructure', name: 'infrastructure', owner: 'perfectuser21' },
  { path: '/home/xx/perfect21/investment/trading-system', name: 'trading-system', owner: 'perfectuser21' },
  { path: '/home/xx/perfect21/toutiao-publisher-system', name: 'toutiao-publisher-system', owner: 'perfectuser21' },
  { path: '/home/xx/perfect21/platform/infra', name: 'platform-infra', owner: 'perfectuser21' },
];
```

**Task Metadata**ï¼š
```json
{
  "pr_number": 123,
  "pr_author": "username",
  "pr_files": ["path/to/file1.js", "path/to/file2.js"],
  "source": "pr_import",
  "repo": "cecelia-core"
}
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
ğŸš€ å¯¼å…¥æ‰€æœ‰ Repository çš„ PR åˆ° Task Database

ğŸ“¦ cecelia-core (perfectuser21/cecelia-core)
   Found 172 merged PRs
   âœ… Imported 172 new tasks

ğŸ“¦ cecelia-engine (perfectuser21/cecelia-engine)
   Found 489 merged PRs
   âœ… Imported 489 new tasks

...

ğŸ“Š å¯¼å…¥æ€»ç»“
   cecelia-core                   172 PRs (172 new)
   cecelia-engine                 489 PRs (489 new)
   ...

âœ… æ€»è®¡: 947 PRs, æ–°å¯¼å…¥ 947 tasks
```

### 2. pgvector å®‰è£…è„šæœ¬

**ä½ç½®**ï¼š`scripts/setup-embeddings.sh`

**åŠŸèƒ½**ï¼š
- æ£€æµ‹ PostgreSQL ç‰ˆæœ¬
- å®‰è£… pgvector æ‰©å±•
- åœ¨ cecelia æ•°æ®åº“å¯ç”¨ pgvector
- éªŒè¯å®‰è£…æˆåŠŸ

**æ‰§è¡Œç¤ºä¾‹**ï¼š
```bash
cd /home/xx/perfect21/infrastructure
bash scripts/setup-embeddings.sh

# è¾“å‡ºï¼š
âœ… PostgreSQL 15.x detected
âœ… pgvector installed
âœ… Extension enabled in cecelia database
âœ… Test query successful
```

### 3. Embedding æ¶æ„æ–‡æ¡£

**ä½ç½®**ï¼š`docs/database/embeddings.md`

**å†…å®¹**ï¼š
- ä¸ºä»€ä¹ˆéœ€è¦ Embeddingï¼ˆç›¸ä¼¼åº¦æœç´¢ï¼‰
- Phase 0: Jaccardï¼ˆå…è´¹ï¼Œå½“å‰å®ç°ï¼‰
- Phase 1: OpenAI Embeddingsï¼ˆè®¡åˆ’ä¸­ï¼‰
- è¡¨ç»“æ„è®¾è®¡
- æˆæœ¬åˆ†æï¼ˆ~$0.30 for 5 yearsï¼‰
- åƒåœ¾æ•°æ®ç®¡ç†ç­–ç•¥ï¼ˆ4-layer defenseï¼‰

### 4. å®šæœŸæ›´æ–°ä»»åŠ¡ï¼ˆå¯é€‰ï¼‰

**ä½ç½®**ï¼š`scripts/setup-pr-import-cron.sh`

**åŠŸèƒ½**ï¼š
- è®¾ç½® cron jobï¼Œæ¯å‘¨è‡ªåŠ¨è¿è¡Œ import-all-prs.js
- æ›´æ–°å¢é‡ PRs

## éåŠŸèƒ½éœ€æ±‚

1. **å¹‚ç­‰æ€§**ï¼šé‡å¤è¿è¡Œä¸ä¼šåˆ›å»ºé‡å¤æ•°æ®
2. **é”™è¯¯å¤„ç†**ï¼šå•ä¸ª repo å¤±è´¥ä¸å½±å“å…¶ä»– repos
3. **æ€§èƒ½**ï¼šå¯¼å…¥ 1000 PRs < 5 åˆ†é’Ÿ
4. **æ—¥å¿—**ï¼šæ¸…æ™°çš„è¿›åº¦å’Œé”™è¯¯ä¿¡æ¯

## æˆåŠŸæ ‡å‡†

### DoD Checklist

- [ ] `scripts/import-all-prs.js` åˆ›å»ºå®Œæˆ
- [ ] `scripts/setup-embeddings.sh` åˆ›å»ºå®Œæˆ
- [ ] `docs/database/embeddings.md` åˆ›å»ºå®Œæˆ
- [ ] æ‰€æœ‰è„šæœ¬æœ‰å¯æ‰§è¡Œæƒé™ï¼ˆchmod +xï¼‰
- [ ] README æ›´æ–°ï¼Œè¯´æ˜å¦‚ä½•ä½¿ç”¨
- [ ] æµ‹è¯•ï¼šæˆåŠŸå¯¼å…¥æ‰€æœ‰ repos çš„ PRs
- [ ] æµ‹è¯•ï¼špgvector å®‰è£…æˆåŠŸ
- [ ] éªŒè¯ï¼šcecelia-core çš„ similarity.js ä»èƒ½æ­£å¸¸å·¥ä½œ

### éªŒæ”¶æµ‹è¯•

```bash
# 1. å¯¼å…¥ PRs
cd /home/xx/perfect21/infrastructure
node scripts/import-all-prs.js

# éªŒè¯ï¼š
psql -U cecelia -d cecelia -c "SELECT COUNT(*) FROM tasks WHERE metadata->>'source' = 'pr_import';"
# æœŸæœ›ï¼š~947 æˆ–æ›´å¤š

# 2. å®‰è£… pgvector
bash scripts/setup-embeddings.sh

# éªŒè¯ï¼š
psql -U cecelia -d cecelia -c "SELECT * FROM pg_extension WHERE extname = 'vector';"
# æœŸæœ›ï¼šè¿”å› 1 è¡Œ

# 3. æµ‹è¯• Brain APIï¼ˆcecelia-coreï¼‰
curl -s localhost:5221/api/brain/search-similar \
  -H "Content-Type: application/json" \
  -d '{"query": "add user authentication", "type": "task"}' | jq
# æœŸæœ›ï¼šè¿”å›ç›¸ä¼¼ä»»åŠ¡åˆ—è¡¨
```

## ä¾èµ–

- PostgreSQL 15.xï¼ˆå·²å®‰è£…ï¼‰
- gh CLIï¼ˆGitHub CLIï¼Œå·²å®‰è£…ï¼‰
- Node.js 18+ï¼ˆå·²å®‰è£…ï¼‰
- cecelia-core Brain APIï¼ˆå·²å®ç° similarity.jsï¼‰

## é£é™©

1. **å†å²æ•°æ®è´¨é‡**ï¼šè€ PR çš„ title/body å¯èƒ½ä¸å¤Ÿæ¸…æ™°
   - ç¼“è§£ï¼šé€šè¿‡ metadata.repo è¿‡æ»¤ï¼Œä¼˜å…ˆæœç´¢ç›¸å…³ä»“åº“

2. **Token æˆæœ¬**ï¼šPhase 1 å‡çº§åˆ° Embeddings åçš„æŒç»­æˆæœ¬
   - ç¼“è§£ï¼šå·²åˆ†ææˆæœ¬ ~$0.30 for 5 yearsï¼Œå¯æ¥å—

3. **åƒåœ¾æ•°æ®ç´¯ç§¯**ï¼šè¿‡æ—¶/åºŸå¼ƒçš„ tasks æ±¡æŸ“æœç´¢ç»“æœ
   - ç¼“è§£ï¼š4-layer defenseï¼ˆstatus marking, time decay, periodic cleanup, manual toolsï¼‰

## å®ç°ä¼˜å…ˆçº§

**P0 - ç«‹å³åš**ï¼š
1. åˆ›å»º `scripts/import-all-prs.js`
2. è¿è¡Œå¯¼å…¥ï¼Œå¡«å…… Task Database

**P1 - æœ¬å‘¨åš**ï¼š
3. åˆ›å»º `scripts/setup-embeddings.sh`
4. åˆ›å»º `docs/database/embeddings.md`

**P2 - å¯é€‰**ï¼š
5. è®¾ç½® cron job è‡ªåŠ¨æ›´æ–°

## è¿ç§»è®¡åˆ’

ä» cecelia-core è¿ç§»åˆ° infrastructureï¼š

1. **å¤åˆ¶æ–‡ä»¶**ï¼š
   - `cecelia-core/brain/import-all-prs.js` â†’ `infrastructure/scripts/import-all-prs.js`

2. **æ›´æ–°æ•°æ®åº“è¿æ¥**ï¼š
   ```javascript
   // ä» import pool from './src/db.js'
   // æ”¹ä¸ºç›´æ¥è¿æ¥
   import pg from 'pg';
   const { Pool } = pg;

   const pool = new Pool({
     host: 'localhost',
     port: 5432,
     database: 'cecelia',
     user: 'cecelia',
     password: 'cecelia'
   });
   ```

3. **ä¿ç•™åœ¨ cecelia-core**ï¼š
   - `brain/src/similarity.js`ï¼ˆBrain API çš„ä¸€éƒ¨åˆ†ï¼‰
   - `brain/src/routes.js`ï¼ˆ/api/brain/search-similar ç­‰ç«¯ç‚¹ï¼‰
   - Migration filesï¼ˆè¡¨ç»“æ„è·Ÿç€æœåŠ¡èµ°ï¼‰

## å‚è€ƒ

- å·²å®ç°çš„ import-all-prs.jsï¼š`/home/xx/perfect21/cecelia/core/brain/import-all-prs-simple.js`
- Brain Attachment Decision API æ–‡æ¡£ï¼š`/home/xx/perfect21/cecelia/core/docs/brain-attach-decision-api.md`
- Infrastructure èŒè´£åˆ’åˆ†ï¼š`/home/xx/perfect21/infrastructure/docs/INFRASTRUCTURE_OWNERSHIP.md`
