# PRD: NAS 内容管理工具脚本

## 概述

创建一个命令行工具 `nas-content-manager.sh`，用于管理 NAS 上的内容资产。该工具设计为可被 N8N workflows 和 Skills 调用的自动化接口。

## 目标

提供统一的 NAS 内容管理接口，支持内容的全生命周期操作（创建、读取、更新、查询、统计）。

## 位置

`infrastructure/scripts/nas-content-manager.sh`

## NAS 配置

- **NAS IP**: 100.110.241.76
- **NAS 用户**: 徐啸
- **基础路径**: `/volume1/workspace/vault/zenithjoy-creator/content`
- **连接方式**: SSH（已配置无密码登录 + passwordless sudo）

## 内容目录结构

```
/volume1/workspace/vault/zenithjoy-creator/content/
└── <content_id>/
    ├── manifest.json
    ├── text/
    │   ├── text_v1.md
    │   └── text_v2.md
    ├── images/
    │   ├── cover.png
    │   └── inline_1.png
    ├── videos/
    ├── exports/
    └── logs/
```

## manifest.json 格式

```json
{
  "content_id": "2025-11-03-abc123",
  "version": 1,
  "title": "文章标题",
  "content_type": "deep-post",
  "platforms": ["xhs", "weibo"],
  "assets": {
    "text": "/path/to/text_v1.md",
    "images": [
      {"role": "cover", "path": "/path/to/cover.png"}
    ],
    "videos": []
  },
  "tags": ["AI", "创作"],
  "status": {
    "state": "draft",
    "created_at": "2025-11-03T10:00:00+08:00",
    "updated_at": "2025-11-03T10:00:00+08:00"
  }
}
```

## 功能需求

### 1. list - 列出所有内容

**命令**: `./nas-content-manager.sh list`

**输出格式**: `content_id | status | type | title`

**示例**:
```
2025-11-03-abc123 | draft | deep-post | 文章标题
2025-11-04-def456 | published | short-post | 短文
```

### 2. show - 查看内容详情

**命令**: `./nas-content-manager.sh show <content_id>`

**输出**:
- Manifest JSON（格式化）
- 文件列表（find 输出）

### 3. read - 读取文本内容

**命令**: `./nas-content-manager.sh read <content_id> [version]`

**参数**:
- `content_id`: 内容 ID
- `version`: 可选，默认 v1（对应 text_v1.md）

**输出**: 文本文件内容

### 4. update-text - 更新文本内容

**命令**: `./nas-content-manager.sh update-text <content_id> <local_file> [version]`

**功能**:
1. 上传本地文件到 NAS
2. 保存为 `text/text_<version>.md`
3. 更新 manifest.json 的 `status.updated_at`

### 5. update-status - 更新状态

**命令**: `./nas-content-manager.sh update-status <content_id> <state>`

**状态值**:
- `draft`: 草稿
- `ready`: 准备发布
- `publishing`: 发布中
- `published`: 已发布
- `failed`: 失败

**功能**: 更新 manifest.json 的 `status.state` 和 `status.updated_at`

### 6. add-platform - 添加平台

**命令**: `./nas-content-manager.sh add-platform <content_id> <platform>`

**平台值**: `xhs`, `weibo`, `douyin`, `toutiao`

**功能**: 向 manifest.json 的 `platforms` 数组添加平台（去重）

### 7. upload-image - 上传图片

**命令**: `./nas-content-manager.sh upload-image <content_id> <local_file> [role]`

**参数**:
- `role`: 图片角色，默认 `cover`（可选值：cover, inline, thumbnail）

**功能**:
1. 上传图片到 `images/` 目录
2. 更新 manifest.json 的 `assets.images` 数组

### 8. search - 搜索内容

**命令**: `./nas-content-manager.sh search <keyword>`

**功能**: 在所有 manifest.json 中搜索关键词

**输出**: `content_id | title`

### 9. filter - 按状态筛选

**命令**: `./nas-content-manager.sh filter <status>`

**输出**: 指定状态的所有内容

### 10. stats - 统计信息

**命令**: `./nas-content-manager.sh stats`

**输出**:
- 总内容数
- 按类型统计
- 按状态统计

### 11. create - 创建新内容

**命令**: `./nas-content-manager.sh create <content_id> <title> [content_type]`

**参数**:
- `content_type`: 默认 `article`（可选值：deep-post, short-post, broad-post, newsletter, explainer）

**功能**:
1. 创建目录结构
2. 生成初始 manifest.json

### 12. help - 显示帮助

**命令**: `./nas-content-manager.sh help`

**输出**: 使用说明

## 技术要求

1. **错误处理**:
   - 检查 content_id 是否存在
   - 验证文件路径
   - 捕获 SSH/SCP 错误

2. **输出格式**:
   - 使用颜色区分日志级别（INFO/WARN/ERROR）
   - JSON 输出使用 `jq` 格式化

3. **原子操作**:
   - 文件先上传到 `/tmp/`，再 `sudo mv` 到目标位置
   - Manifest 更新使用 `jq` + 临时文件

4. **可调用性**:
   - 所有命令返回明确的退出码（0 成功，1 失败）
   - 错误信息输出到 stderr

## 使用场景

### N8N Workflow 调用

```javascript
// N8N Execute Command 节点
{
  "command": "/home/xx/perfect21/infrastructure/scripts/nas-content-manager.sh",
  "arguments": ["update-status", "2025-11-03-abc123", "published"]
}
```

### Claude Skills 调用

```bash
# 在 Skill 中调用
bash /home/xx/perfect21/infrastructure/scripts/nas-content-manager.sh list | grep draft
```

## 验收标准

1. ✅ 所有 12 个命令实现且可用
2. ✅ 错误处理完整（不存在的 content_id、无效参数等）
3. ✅ 输出格式清晰（颜色、格式化 JSON）
4. ✅ 可在 N8N 和 Skills 中成功调用
5. ✅ 原子操作保证数据一致性

## 非目标

- ❌ 不实现 Web UI
- ❌ 不处理视频上传（视频文件过大）
- ❌ 不实现内容版本控制（只管理当前版本）
- ❌ 不实现用户权限管理（依赖已有的 SSH 配置）

## 依赖

- SSH 无密码登录到 NAS
- NAS 上的 passwordless sudo
- `jq` 工具（本地和 NAS 上都需要）
- `bash` 4.0+

## 后续扩展

- 支持批量操作
- 支持内容备份/恢复
- 支持内容归档（移动到 archive 目录）
- 集成到 Cecelia Brain API
