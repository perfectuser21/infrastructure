---
title: DoD - 全局 PR 导入和 Embedding 基础设施
created: 2026-02-12
type: infrastructure
priority: P1
---

# DoD: 全局 PR 导入和 Embedding 基础设施

## 验收清单

### 1. 代码文件创建

- [ ] `scripts/import-all-prs.js` 创建完成
      Test: manual:文件存在且可执行
- [ ] 包含所有 13 个 repos 的配置
      Test: manual:代码审查
- [ ] 使用 gh CLI 获取 merged PRs
      Test: manual:执行脚本验证
- [ ] 幂等性：已存在的 PR 不重复导入
      Test: manual:重复运行验证
- [ ] 错误处理：单个 repo 失败不影响其他 repos
      Test: manual:错误场景测试
- [ ] 进度日志清晰可读
      Test: manual:执行脚本观察输出

- [ ] `scripts/setup-embeddings.sh` 创建完成
      Test: manual:文件存在且可执行
- [ ] 检测 PostgreSQL 版本
      Test: manual:执行脚本验证
- [ ] 安装 pgvector 扩展
      Test: manual:psql检查扩展
- [ ] 启用扩展到 cecelia 数据库
      Test: manual:psql验证
- [ ] 验证安装成功
      Test: manual:测试向量查询
- [ ] 错误处理和友好提示
      Test: manual:错误场景测试

- [ ] 所有脚本有可执行权限
      Test: manual:ls -la验证

### 2. 文档创建

- [ ] `docs/database/embeddings.md` 创建完成
      Test: manual:文件存在且内容完整
- [ ] 架构说明
      Test: manual:文档审查
- [ ] Phase 0 (Jaccard) 实现
      Test: manual:文档审查
- [ ] Phase 1 (OpenAI Embeddings) 计划
      Test: manual:文档审查
- [ ] 成本分析
      Test: manual:文档审查
- [ ] 垃圾数据管理策略
      Test: manual:文档审查

- [ ] `README.md` 更新
      Test: manual:文件存在且内容更新
- [ ] 添加 PR 导入说明
      Test: manual:文档审查
- [ ] 添加 Embedding 安装说明
      Test: manual:文档审查
- [ ] 添加使用示例
      Test: manual:文档审查

### 3. 功能测试

- [ ] **测试 1: PR 导入** - 验证脚本能成功导入所有 PRs
      Test: manual:node scripts/import-all-prs.js && psql验证数量

- [ ] **测试 2: 幂等性验证** - 重复运行不会创建重复数据
      Test: manual:重复运行脚本 && psql验证数量不变

- [ ] **测试 3: pgvector 安装** - 扩展安装成功且可用
      Test: manual:bash scripts/setup-embeddings.sh && psql验证扩展

- [ ] **测试 4: Brain API 兼容性** - similarity.js 仍能正常工作
      Test: manual:curl localhost:5221/api/brain/search-similar

### 4. 性能验证

- [ ] 导入 ~947 PRs 总耗时 < 5 分钟
      Test: manual:执行脚本并计时
- [ ] 每个 repo 的进度实时显示
      Test: manual:观察脚本输出
- [ ] 错误时有清晰的错误信息
      Test: manual:错误场景测试

### 5. 数据库验证

- [ ] projects 表正确创建/关联所有 repos（期望13个）
      Test: manual:psql -c "SELECT name, repo_path FROM projects WHERE repo_path IS NOT NULL;"

- [ ] tasks 表的 metadata 字段包含正确信息
      Test: manual:psql查询 metadata 字段验证

### 6. 清理和文档

- [ ] 旧的临时文件已删除或归档
      Test: manual:ls检查临时文件
- [ ] 代码有适当的注释
      Test: manual:代码审查
- [ ] README 清晰说明使用步骤
      Test: manual:文档审查
- [ ] 所有脚本都有使用示例
      Test: manual:文档审查

## 回滚计划

如果导入失败或有问题：

```bash
# 删除所有导入的 PRs
psql -U cecelia -d cecelia -c "DELETE FROM tasks WHERE metadata->>'source' = 'pr_import';"

# 删除自动创建的 projects（如果需要）
psql -U cecelia -d cecelia -c "DELETE FROM projects WHERE metadata->>'auto_created' = 'true';"

# 卸载 pgvector（如果需要）
psql -U cecelia -d cecelia -c "DROP EXTENSION IF EXISTS vector CASCADE;"
```

## 完成标准

**当以上所有检查项都通过时，此任务视为完成。**

**核心验证**：
1. ✅ ~947+ PRs 成功导入到 tasks 表
2. ✅ pgvector 扩展安装成功
3. ✅ Brain API 能正常搜索相似任务
4. ✅ 所有文档完整清晰
5. ✅ 幂等性验证通过
